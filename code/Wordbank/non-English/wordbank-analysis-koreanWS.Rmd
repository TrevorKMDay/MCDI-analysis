---
title: "Korean MB-CDI WS Analysis"
author: "Trevor Day"
date: "8/2/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup

```{r setup-data}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
setwd("G:/My Drive/Research/MCDI/MCDI-analysis/code/Wordbank")

library(tidyverse)
library(psych)
library(lavaan)

source("../mcdi-setup.R")
source("wordbank-functions.R")

# Date of download from Wordbank
ko <- read_data("Wordbank/Wordbank-Korean-WS-210715.csv")

```

# Data Cleaning

```{r data-clean}

# Extract demographics per kid
ko_demo <- ko %>%
  select(data_id, age, sex, mom_ed) %>%
  distinct()

head(ko_demo)

# Morphology section (1 section with five non yet/sometimes/often Qs)
# Sections:
#   Participle use (pro/nouns)
#   Word ending transformation
#   Connecting word ending
#   Adnomial word ending
#   Past or progressive verb affix
ko_morph <- ko %>%
  filter(
    type == "sentence_structure"
  ) %>%
  mutate(
    score = score.SONy(value) %>%
              replace_na(0)
  ) %>%
  group_by(data_id) %>%
  summarize(
    morph_n = n(),
    morph_score = sum(score)
  ) %>%
  mutate(
    morph_p = morph_score / 10
  )

head(ko_morph)

# Extract complexity score (1 per kid)
ko_complexity <- ko %>%
  filter(
    type == "complexity"
  ) %>%
  mutate(
    value = as.numeric(value)
  ) %>%
  group_by(data_id) %>%
  summarize(
    n = n(),
    sum = sum(value, na.rm = TRUE)
  ) %>%
  mutate(
    complexity = sum / (n * 2)
  )

head(ko_complexity)

ko_scored <- ko %>%
  filter(
    type == "word"
  ) %>%
  mutate(
    value_numeric = score.produces(value)
  ) %>%
  group_by(data_id, category) %>%
  summarize(
    n = n(),
    sum = sum(value_numeric)
  ) %>%
  mutate(
    perc = sum / n
  )


ko_scored_n <- pivot_wider(ko_scored,
                           id_cols = data_id, names_from = category,
                           values_from = sum) %>%
  left_join(select(ko_complexity, data_id, sum)) %>%
  left_join(select(ko_morph, data_id, morph_score)) %>%
  rename(
    complexity = sum
  )

head(ko_scored_n)

ko_scored_p <- pivot_wider(ko_scored,
                           id_cols = data_id, names_from = category,
                           values_from = perc) %>%
  left_join(select(ko_complexity, data_id, complexity)) %>%
  left_join(select(ko_morph, data_id, morph_p))

head(ko_scored_p)

```

# Factor Analysis

```{r fa}

# Consistent seed
set.seed(55455)

efa1 <- WS.merge1 <- ko_demo %>%
  group_by(age, sex, mom_ed) %>%
  sample_frac(size = .5)

efa.half <- ko_scored_p %>%
  filter(
    data_id %in% efa1$data_id
  ) %>%
  ungroup()

fa.parallel.plot <- efa.half %>%
  select(-data_id) %>%
  fa.parallel(fa = "fa")

```

Sorry, unfortunately these plots don't work very well, but you can see that 
the usefulness of the two-factor solution declines rapidly.

```{r fa2, echo=TRUE, fig.height=4, fig.width=6, message=FALSE, warning=FALSE}

cfa.half <- ko_scored_p %>%
  filter(
    !(data_id %in% efa1$data_id)
  ) %>%
  ungroup()

factor.analyses <- lapply(1:5, function(x) fa(select(efa.half, -data_id),
                                              nfactors = x))

for (i in 1:5) 
  print( fa.diagram(factor.analyses[[i]]) )


nobs <- list(nrow(cfa.half), nrow(efa.half))
measures <- c("pvalue", "cfi.robust", "tli.robust", "rmsea", "srmr")

# Skipping 4-5 because broken
fa_tbl <- tibble(nf = 1:3) %>%
  mutate(
    efa = map(nf,      ~fa(select(efa.half, -data_id), .x, rotate = "Promax", 
                            weight = NULL)),
    model = map(efa,   ~structure.diagram(.x, cut = 0.6, errors = TRUE)$lavaan),
    cfa   = map(model, ~cfa(model = .x,
                             data = select(cfa.half, -data_id),
                             sample.nobs = nobs,
                             estimator = "MLR")),
    summary = map(cfa, ~summary(.x, fit.measures = TRUE)$FIT[measures]) 
  )


```

Remember the criteria for these fit statistics are:

```
pvalue    cfi   tli   rmsea   srmr
>.05      >=.9  >=.9  <.08    <.08

```

```{r tbl, message=FALSE, warning=FALSE}

fas_summary <- fa_tbl %>%
  select(nf, summary) %>%
  unnest(summary) %>%
  add_column(meas = rep(measures, length.out = nrow(.))) %>%
  pivot_wider(names_from = meas, values_from = summary)

fas_summary
```

# Summary 

With only two factors, only SRMR is OK, but with three, CFI, TLI, and SRMR are 
OK, which is consistent with English.

But, when we look at the factor structure, the only thing in Factor 2 in the 
two-factor solution is the complexity and morphology score. That's not very 
helpful. This is the same as Factor 3 in the three-factor solution, whereas
Factor 2 is much more similar to the English structural factor. 
